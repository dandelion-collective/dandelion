<div class="form-group">
  <label>
    Ticket types
  </label>
  <div>
    <div id="ticket_types">
      <% f.fields_for :ticket_types, f.object.ticket_types.sort_by(&:order) do |o| %>
        <div class="ticket_type <%= 'has-error' if o.object.invalid? %>">
          <%= o.hidden_field :order %>
          <div>
            <%= o.text_field :name, class: 'form-control', placeholder: 'Name' %>
          </div>
          <div>
            <%= Money.new(0, f.object.currency).symbol %><%= o.number_field :price, class: 'form-control ml-1', placeholder: 'Price', step: 'any' %>
          </div>
          <div>
            &times;<%= o.number_field :quantity, class: 'form-control ml-1', placeholder: 'Quantity' %>
          </div>
          <label>
            Limit per order <%= o.number_field :max_quantity_per_transaction, class: 'form-control' %>
          </label><% if f.object.ticket_groups.select(&:persisted?).length > 0 %><label>
              Group <%= o.select :ticket_group_id, options: [''] + f.object.ticket_groups.select(&:persisted?).map { |ticket_group| [ticket_group.name, ticket_group.id] }, class: 'form-control ml-1' %>
            </label><% end %><label>
            Hidden? <%= o.check_box :hidden %>
          </label>
          <% if o.object.new_record? %>
            <span>
              <i style="cursor: pointer" onclick="$(this).closest('.ticket_type').remove()" class="fa fa-times"></i>
            </span>
          <% else %>
            <span>
              <i style="cursor: pointer" onclick="$(this).siblings().last().prop('checked', true).closest('.ticket_type').hide()" class="fa fa-times"></i>
              <%= o.check_box '_destroy', style: 'display: none' %>
            </span>
          <% end %>
        </div>
      <% end %>
    </div>
    <div id="ticket_types_add">
      <i style="cursor: pointer" class="text-muted fa fa-plus-square"></i>
      <a class="text-muted" href="javascript:;">Add ticket type</a>
    </div>
    <style>
      .ticket_type { margin-bottom: 10px; padding-left: 10px; border-left: 4px solid #ddd; }
      .ticket_type > div, .ticket_type > label { display: inline-block; margin-bottom: 5px; margin-right: 5px }
      .ticket_type input[name$='[name]'] { display: inline-block; width: auto }
      .ticket_type input[name$='[price]'] { display: inline-block; width: 5em }
      .ticket_type input[name$='[quantity]'] { display: inline-block; width: 7em }
      .ticket_type input[name$='[max_quantity_per_transaction]'] { display: inline-block; width: 5em }
      .ticket_type select[name$='[ticket_group_id]'] { display: inline-block; width: auto }
    </style>
    <script>
      $(function () {

        $("#ticket_types").sortable().closest('form').submit(function () {
          $('.ticket_type').each(function (i) {
            $("input[name$='[order]']", this).val(i)
          })
        })

        $('#ticket_types_add a').click(function () {
          var c = $('.ticket_type').length

          var d = $('<div class="ticket_type"/>');

          var orderInput = $('<input type="hidden" />');
          orderInput.attr('name', 'event[ticket_types_attributes][' + c + '][order]');
          orderInput.attr('id', 'event_ticket_types_attributes_' + c + '_order');
          orderInput.appendTo(d);

          var nameDiv = $('<div></div>')
          var nameInput = $('<input type="text" />');
          nameInput.attr('name', 'event[ticket_types_attributes][' + c + '][name]');
          nameInput.attr('id', 'event_ticket_types_attributes_' + c + '_name');
          nameInput.attr('placeholder', 'Name');
          nameInput.addClass('form-control');
          nameInput.appendTo(nameDiv);
          nameDiv.appendTo(d);

          var priceDiv = $('<div><%= Money.new(0, f.object.currency).symbol %></div>')
          var priceInput = $('<input type="number" step="any" />');
          priceInput.attr('name', 'event[ticket_types_attributes][' + c + '][price]');
          priceInput.attr('id', 'event_ticket_types_attributes_' + c + '_price');
          priceInput.attr('placeholder', 'Price');
          priceInput.attr('step', 'any');
          priceInput.addClass('form-control ml-1');
          priceInput.appendTo(priceDiv);
          priceDiv.appendTo(d);

          var quantityDiv = $('<div>&times;</div>')
          var quantityInput = $('<input type="number" step="any" />');
          quantityInput.attr('name', 'event[ticket_types_attributes][' + c + '][quantity]');
          quantityInput.attr('id', 'event_ticket_types_attributes_' + c + '_quantity');
          quantityInput.attr('placeholder', 'Quantity');
          quantityInput.addClass('form-control ml-1');
          quantityInput.appendTo(quantityDiv);
          quantityDiv.appendTo(d);

          var maxQuantityPerTransactionDiv = $('<label>Limit per order </label>')
          var maxQuantityPerTransactionInput = $('<input type="number" step="any" />');
          maxQuantityPerTransactionInput.attr('name', 'event[ticket_types_attributes][' + c + '][max_quantity_per_transaction]');
          maxQuantityPerTransactionInput.attr('id', 'event_ticket_types_attributes_' + c + '_max_quantity_per_transaction');
          maxQuantityPerTransactionInput.addClass('form-control');
          maxQuantityPerTransactionInput.appendTo(maxQuantityPerTransactionDiv);
          maxQuantityPerTransactionDiv.appendTo(d);

      <% if f.object.ticket_groups.select(&:persisted?).length > 0 %>
            var ticketGroupDiv = $('<label>Group </label>')
            var ticketGroupInput = $('<select><option></option></select>');
        <% f.object.ticket_groups.select(&:persisted?).each { |ticket_group| %>
              ticketGroupInput.append('<option value="<%= ticket_group.id %>"><%= escape_html ticket_group.name %></option>')
        <% } %>
            ticketGroupInput.attr('name', 'event[ticket_types_attributes][' + c + '][ticket_group_id]');
            ticketGroupInput.attr('id', 'event_ticket_types_attributes_' + c + '_ticket_group_id');
            ticketGroupInput.addClass('form-control ml-1');
            ticketGroupInput.appendTo(ticketGroupDiv);
            ticketGroupDiv.appendTo(d);
      <% end %>

          var hiddenDiv = $('<label>Hidden? </label>')
          var hiddenInput0 = $('<input type="hidden" value="0">')
          hiddenInput0.attr('name', 'event[ticket_types_attributes][' + c + '][hidden]');
          var hiddenInput1 = $('<input type="checkbox" value="1">')
          hiddenInput1.attr('name', 'event[ticket_types_attributes][' + c + '][hidden]');
          hiddenInput1.attr('id', 'event_ticket_types_attributes_' + c + '_hidden');
          hiddenInput0.appendTo(hiddenDiv);
          hiddenInput1.appendTo(hiddenDiv);
          hiddenDiv.appendTo(d);

          $('<span><i style="cursor: pointer" onclick="$(this).closest(\'.ticket_type\').remove()" class="fa fa-times"></i></span>').appendTo(d);

          d.appendTo('#ticket_types');
        });
      });
    </script>
  </div>
</div>
